---
// Open Source repositories section - GitHub API Integration
const GITHUB_TOKEN = import.meta.env.GITHUB_TOKEN;
const GITHUB_USERNAME = 'ivanmercedes'; // Tu username de GitHub

// Language colors mapping (GitHub standard colors)
const languageColors: Record<string, string> = {
  'TypeScript': 'bg-blue-500',
  'JavaScript': 'bg-yellow-400',
  'PHP': 'bg-purple-500',
  'Rust': 'bg-orange-500',
  'Lua': 'bg-blue-400',
  'Python': 'bg-blue-600',
  'Go': 'bg-cyan-500',
  'Ruby': 'bg-red-500',
  'Java': 'bg-orange-600',
  'C++': 'bg-pink-500',
  'Shell': 'bg-green-500',
};

let repos = [];

try {
  if (GITHUB_TOKEN) {
    // Fetch pinned repositories using GitHub GraphQL API
    const response = await fetch('https://api.github.com/graphql', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        query: `
          query {
            user(login: "${GITHUB_USERNAME}") {
              pinnedItems(first: 6, types: REPOSITORY) {
                nodes {
                  ... on Repository {
                    name
                    description
                    url
                    stargazerCount
                    forkCount
                    primaryLanguage {
                      name
                    }
                  }
                }
              }
            }
          }
        `
      })
    });

    const data = await response.json();
    
    if (data.data?.user?.pinnedItems?.nodes) {
      repos = data.data.user.pinnedItems.nodes.map((repo: {
        name: string;
        description: string | null;
        url: string;
        stargazerCount: number;
        forkCount: number;
        primaryLanguage: { name: string } | null;
      }) => ({
        name: repo.name,
        description: repo.description || 'Sin descripción',
        language: repo.primaryLanguage?.name || 'Unknown',
        languageColor: repo.primaryLanguage?.name 
          ? (languageColors[repo.primaryLanguage.name] || 'bg-gray-500')
          : 'bg-gray-500',
        stars: repo.stargazerCount >= 1000 
          ? `${(repo.stargazerCount / 1000).toFixed(1)}k` 
          : repo.stargazerCount.toString(),
        forks: repo.forkCount.toString(),
        url: repo.url
      }));
    }
  }
} catch (error) {
  console.error('Error fetching GitHub repos:', error);
}

// Fallback data if API fails or token is not set
if (repos.length === 0) {
  repos = [
    {
      name: 'laravel-route-preview',
      description: 'Una herramienta para previsualizar rutas de Laravel directamente desde tu editor.',
      language: 'PHP',
      languageColor: 'bg-purple-500',
      stars: '0',
      forks: '0',
      url: 'https://github.com/ivanmercedes/laravel-route-preview'
    },
    {
      name: 'Configura tu token de GitHub',
      description: 'Agrega GITHUB_TOKEN a tu archivo .env para ver tus repositorios pinned automáticamente.',
      language: 'Config',
      languageColor: 'bg-gray-500',
      stars: '0',
      forks: '0',
      url: 'https://github.com/ivanmercedes'
    },
  ];
}
---

<section id="repos" class="py-16 border-t border-white/5 bg-neutral-900/20">
  <div class="max-w-6xl mx-auto px-6">
    <div class="flex items-center justify-between mb-10">
      <h2 class="text-2xl font-medium text-white tracking-tight">Open Source</h2>
      <a href="https://github.com/ivanmercedes" target="_blank" class="text-sm text-neutral-500 hover:text-white transition-colors flex items-center gap-1">
        Ver GitHub <span class="iconify" data-icon="lucide:arrow-right" data-width="14"></span>
      </a>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {repos.map((repo: { url: string | URL | null | undefined; name: unknown; description: unknown; languageColor: any; language: unknown; stars: unknown; forks: unknown; }) => (
        <a href={repo.url} class="group block p-5 rounded-xl border border-white/5 bg-neutral-900/40 hover:border-white/10 hover:bg-neutral-900/60 transition-all duration-300">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
              <span class="iconify text-neutral-400 group-hover:text-white transition-colors" data-icon="lucide:book-marked" data-width="18"></span>
              <span class="font-medium text-neutral-200 group-hover:text-white transition-colors">{repo.name}</span>
            </div>
            <span class="iconify text-neutral-600 group-hover:text-white transition-all transform group-hover:translate-x-1 group-hover:-translate-y-1" data-icon="lucide:arrow-up-right" data-width="16"></span>
          </div>
          <p class="text-sm text-neutral-500 mb-6 line-clamp-2">
            {repo.description}
          </p>
          <div class="flex items-center gap-4 text-xs font-mono text-neutral-500">
            <div class="flex items-center gap-1.5">
              <span class={`w-2 h-2 rounded-full ${repo.languageColor}`}></span>
              {repo.language}
            </div>
            <div class="flex items-center gap-1">
              <span class="iconify" data-icon="lucide:star" data-width="12"></span>
              {repo.stars}
            </div>
            <div class="flex items-center gap-1">
              <span class="iconify" data-icon="lucide:git-fork" data-width="12"></span>
              {repo.forks}
            </div>
          </div>
        </a>
      ))}
    </div>
  </div>
</section>
